name: Build

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    env:
      ZEPHYR_SDK_VERSION: 0.17.4
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: projects
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            git cmake ninja-build gperf ccache dfu-util \
            device-tree-compiler wget xz-utils file make gcc \
            gcc-multilib g++-multilib libsdl2-dev libmagic1
      
      - name: Install West
        run: |
          pip3 install west
      
      - name: Initialize West workspace
        run: |
          west init -l projects
          west update
      
      - name: Cache Zephyr SDK
        id: cache-zephyr-sdk
        uses: actions/cache@v4
        with:
          path: /opt/toolchains/zephyr-sdk-${{ env.ZEPHYR_SDK_VERSION }}
          key: zephyr-sdk-${{ env.ZEPHYR_SDK_VERSION }}-arm
      
      - name: Install Zephyr SDK (ARM only)
        if: steps.cache-zephyr-sdk.outputs.cache-hit != 'true'
        run: |
          wget -q https://github.com/zephyrproject-rtos/sdk-ng/releases/download/v${{ env.ZEPHYR_SDK_VERSION }}/zephyr-sdk-${{ env.ZEPHYR_SDK_VERSION }}_linux-x86_64_minimal.tar.xz
          tar -xf zephyr-sdk-${{ env.ZEPHYR_SDK_VERSION }}_linux-x86_64_minimal.tar.xz
          sudo mv zephyr-sdk-${{ env.ZEPHYR_SDK_VERSION }} /opt/toolchains/
          cd /opt/toolchains/zephyr-sdk-${{ env.ZEPHYR_SDK_VERSION }}
          ./setup.sh -t arm-zephyr-eabi -h -c
      
      - name: Export Zephyr environment
        run: |
          west zephyr-export
      
      - name: Build project
        run: |
          cd projects
          west build -p always -b lirisv3 --sysbuild lirisv4
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: build-artifacts
          path: |
            projects/build/lirisv4/zephyr/zephyr.hex
            projects/build/lirisv4/zephyr/zephyr.elf
            projects/build/mcuboot/zephyr/zephyr.hex
            projects/build/mcuboot/zephyr/zephyr.elf
            projects/build/dfu_application.zip
          retention-days: 30
